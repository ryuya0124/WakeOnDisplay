# WakeOnDisplay

ディスプレイだけがスリープしているPCを、マジックパケットで叩き起こす。

WakeOnDisplayは、ディスプレイのみがスリープ状態のPCに対し、Wake-on-LAN（WoL）のマジックパケットをトリガーとしてディスプレイを復帰させるための、タスクトレイ（メニューバー）常駐型ユーティリティアプリです。

## ✨ 特徴 (Features)

* **ディスプレイの遠隔復帰**: PC本体は起動したまま、ディスプレイだけがスリープしている状態から、マジックパケットで復帰させます。
* **軽量な常駐アプリ**: バックグラウンドで静かに動作し、システムリソースをほとんど消費しません。
* **マルチプラットフォーム**: 💻 Windowsと🍎 macOSに対応しています。
* **シンプルな操作**: タスクトレイ（メニューバー）のアイコンから、すべての設定が完結します。
* **自動起動**: PCの起動時にアプリを自動で開始する設定が簡単に行えます。

## 🤔 なぜこのアプリが必要？ (The Problem to Solve)

省電力設定でディスプレイのみオフになっており、電源ボタンまで指を伸ばさないといけないときがあります。
通常、ディスプレイを復帰させるにはマウスを動かしたりキーボードを叩いたりといった物理的な操作が必要です。

**WakeOnDisplay**は、この問題を解決します。
ローカルネットワーク上の他のデバイスからマジックパケット（WoLの信号）を送信するだけで、物理的な操作なしにスリープ中のディスプレイを起動させることができます。
TailScaleなどを用いると外部ネットワークからでも、物理的な操作なしにスリープ中のディスプレイを起動させることができます。

## 🚀 使い方 (Usage)

1. アプリを起動すると、Windowsではタスクトレイに、macOSではメニューバーにアイコンが表示されます。
2. アイコンを右クリックすると、メニューが表示されます。
    * **自動起動**: チェックを入れると、PCログイン時にWakeOnDisplayが自動で起動します。
    * **スクリプトフォルダを開く**: WoLでディスプレイ復帰時に実行したいスクリプトを配置するフォルダを開きます。
    * **終了**: アプリケーションを完全に終了します。

これだけで、マジックパケットの待受が開始されます。あとは、ディスプレイを復帰させたいタイミングで、スマートフォンや他のPCからWoLアプリを使ってマジックパケットを送信してください。

### スクリプト実行機能（WoL復帰時）(未リリース)

WoLのマジックパケットを検知してディスプレイを復帰させたタイミングで、ユーザーデータ配下の`startup-scripts`フォルダにあるスクリプトを順に実行します。フォルダは初回起動時に自動作成され、トレイメニュー「スクリプトフォルダを開く」から開けます。

* Windows: `.ps1`(PowerShell), `.bat`/`.cmd`
* macOS: `.sh`, `.applescript`/`.scpt`
* Linux: `.sh`

補足:

* 実行は非同期で行われます。標準出力・エラーはアプリのログに記録されます。
* WindowsのPowerShellは`-ExecutionPolicy Bypass`で実行します。必要に応じて各スクリプト側で権限設定を行ってください。
* `.bat`/`.cmd`は厳密引用（`cmd /c "<path>"`）で実行します。
* 各スクリプトの実行タイムアウトは60秒です（超過時は強制終了）。
* スクリプトは通常ユーザー権限のみで実行します。root/管理者権限では実行されません。
  * `.bat`/`.cmd`は`cmd /d /c`で実行（AutoRunを無効化）。PowerShellは`-NoProfile -NonInteractive -NoLogo -WindowStyle Hidden -ExecutionPolicy Bypass`で実行します。
  * WoL後のクールダウン（30秒）と排他制御で多重実行を抑制します。
  * シンボリックリンクは実行対象外。フォルダ外へ解決されるパスも拒否します。
  * アプリは単一インスタンスで動作し、二重起動を防止します。

## 🛠️ インストール (Installation)

1. **[リリースページ](https://github.com/ryuya0124/WakeOnDisplay/releases)** にアクセスします。
2. お使いのOS（Windows / macOS）に合った最新版のインストーラー（`.exe`や`.dmg`）をダウンロードします。
3. ダウンロードしたファイルを実行し、画面の指示に従ってインストールしてください。

## ⚠️ 注意事項 (Important Notes)

* **ポートの競合**: 本アプリは、マジックパケットを待ち受けるためにUDPポート`9`を使用します。もし他のアプリケーションが既にこのポートを使用している場合、本アプリの監視機能は動作しません。その際はエラーメッセージが表示されます。
* **ファイアウォール**: OSやセキュリティソフトのファイアウォール設定によっては、UDPポート`9`への通信がブロックされる場合があります。本アプリの通信を許可するように設定してください。
* **管理者権限**: 自動起動の設定を変更する際に、OSから管理者権限を要求される場合があります。

## 💻 開発者向け (For Developers)

このリポジトリをクローンして、ローカルで開発・実行することができます。

```bash
# 依存関係をインストール
pnpm install

# 開発モードでアプリを起動
pnpm start

# アプリをパッケージング（ビルド）
pnpm dist
```

## 動作の仕組み

* マジックパケットの監視: dgramモジュールを使用してUDPポート9でマジックパケット（FF FF FF FF FF FFから始まる102バイト以上のデータ）を待ち受けます。

* ディスプレイの復帰:

* Windows: PowerShellを介してSystem.Windows.Forms.SendKeysを呼び出し、CAPSLOCKキーを2回押すキーストロークをシミュレートしてディスプレイを復帰させます。

* macOS: caffeinate -u -t 20コマンドを実行し、短時間システムをアクティブな状態にすることでディスプレイを復帰させます。

## 📜 ライセンス (License)

This project is licensed under the MIT License.

### 上記の文章はGeminiに書いてもらいました。学割最高

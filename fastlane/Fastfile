# Fastfile - macOS Developer ID証明書のセットアップとビルド自動化
#
# 使用方法:
#   fastlane mac setup_certificates  - 証明書をキーチェーンにインストール
#
# CI環境では環境変数 MATCH_PASSWORD と MATCH_GIT_BASIC_AUTHORIZATION が必要

default_platform(:mac)

platform :mac do
  desc "Developer ID証明書をセットアップ"
  lane :setup_certificates do
    # CI環境では一時キーチェーンを作成
    if ENV["CI"]
      keychain_name = "ci_keychain"
      keychain_password = ENV["MATCH_PASSWORD"]
      keychain_path = File.expand_path("~/Library/Keychains/#{keychain_name}-db")

      create_keychain(
        name: keychain_name,
        password: keychain_password,
        default_keychain: true,
        unlock: true,
        timeout: 3600,
        lock_when_sleeps: false,
        add_to_search_list: true
      )

      match(
        type: "developer_id",
        readonly: true,
        skip_provisioning_profiles: true,
        keychain_name: keychain_name,
        keychain_password: keychain_password
      )

      # codesignがキーチェーンにアクセスできるようにパーティションリストを設定
      sh("security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k \"#{keychain_password}\" #{keychain_path}")
    else
      # ローカル環境: デフォルトキーチェーンを使用
      match(
        type: "developer_id",
        readonly: true,
        skip_provisioning_profiles: true
      )
    end

    UI.success("Developer ID証明書のセットアップが完了しました")
  end
end

# Fastfile - macOS Developer ID証明書のセットアップとビルド自動化
#
# 使用方法:
#   fastlane mac setup_certificates  - 証明書をキーチェーンにインストール
#
# CI環境では環境変数 MATCH_PASSWORD と MATCH_GIT_BASIC_AUTHORIZATION が必要

default_platform(:mac)

platform :mac do
  desc "Developer ID証明書をセットアップ"
  lane :setup_certificates do
    if ENV["CI"]
      keychain_name = "ci_keychain"
      keychain_password = ENV["MATCH_PASSWORD"]
      keychain_path = File.expand_path("~/Library/Keychains/#{keychain_name}-db")

      # キーチェーンを作成
      create_keychain(
        name: keychain_name,
        password: keychain_password,
        default_keychain: true,
        unlock: true,
        timeout: 3600,
        lock_when_sleeps: false,
        add_to_search_list: true
      )

      # matchで証明書をインストール
      # verbose: trueでデバッグ情報を出力
      match(
        type: "developer_id",
        readonly: true,
        skip_provisioning_profiles: true,
        keychain_name: keychain_name,
        keychain_password: keychain_password,
        verbose: true
      )

      # パーティションリストを設定
      begin
        sh("security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k '#{keychain_password}' '#{keychain_path}'")
      rescue => e
        UI.important("Partition list setting skipped: #{e.message}")
      end

      # デバッグ: キーチェーンの内容を確認
      sh("security find-identity -v -p codesigning '#{keychain_path}'", log: true) rescue nil
    else
      match(
        type: "developer_id",
        readonly: true,
        skip_provisioning_profiles: true
      )
    end

    UI.success("Developer ID証明書のセットアップが完了しました")
  end
end
